name: Deploy BankFlow to Cloud Run

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: bankflow-service
  REGION: us-central1
  REPO_NAME: bankflow-artifacts

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        run: mvn -B clean test

  deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # We skip tests here because they passed in the previous job
      - name: Build Application
        run: mvn -B clean package -DskipTests

      - name: Auth with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # NOTE: Ensure your Dockerfile is actually inside a "docker" folder.
      # If it is in the root, remove "docker/" from the path below.
      - name: Build and Push image
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:latest
          docker build -f docker/Dockerfile -t $IMAGE .
          docker push $IMAGE

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:latest
          flags: >
            --allow-unauthenticated
            --port=8080
            --cpu=1
            --memory=1024Mi
          # CRITICAL FIX:
          # We use the 'dev' profile to get the Secret Manager config,
          # BUT we override the database behavior to 'validate' so we don't delete data.
          env_vars: |
            SPRING_PROFILES_ACTIVE=dev
            SPRING_JPA_HIBERNATE_DDL_AUTO=validate
